using System;
using log4net.Repository.Hierarchy;
using Engine.Cloud.Core.Model;
using System.Configuration;
using System.Xml;
using System.Net.Http;
using System.Text;
using Engine.Cloud.Core.Model.Results;
using Engine.Cloud.Core.Utils.Logging;
using Utils;

namespace Engine.Cloud.Core.Domain.Services.MemoryVcpu
{
    public class MemoryVcpuServiceXenSp : XenServiceBase, IMemoryVcpuService
    {
        private readonly ILogger _logger;
        private readonly Server _server;
        public string UrlBase { get; set; }

        public MemoryVcpuServiceXenSp(Server server)
        {
            _logger = LogFactory.GetInstance();
            UrlBase = ConfigurationManager.AppSettings.Get("Cloud.XenSP1.UrlWS");
            _server = server;
        }

        public ServiceResult Change(byte vcpu, int frequency, int memory)
        {
            var sbBody = "";
            sbBody += "<virtualmachine>";
            sbBody += "<name>" + _server.Name + "</name>";
            sbBody += "<status>upgrade</status>";
            sbBody += "<vcpu>" + vcpu + "</vcpu>";
            sbBody += "<frequency>" + frequency + "</frequency>";
            sbBody += "<memory>" + memory + "</memory>";
            sbBody += "</virtualmachine>";

            var scheduleddate = DateTime.Now.Date.ToString("yyyy-MM-dd");
            var scheduledtime = DateTime.Now.TimeOfDay.ToString().Split('.')[0];

            UrlBase += "cloud/rest/servicecode/" + Guid.NewGuid() + "/scheduleddate/" + scheduleddate + "/scheduledtime/" + scheduledtime + "/virtualmachine";
            var xmlDocument = new XmlDocument();

            HttpResponseMessage httpResponseMessage;

            using (var httpClient = new HttpClient())
            {
                HttpContent myContent = new StringContent(sbBody, Encoding.UTF8, "application/xml");
                httpClient.BaseAddress = new Uri(UrlBase);
                httpResponseMessage = httpClient.PutAsync(UrlBase, myContent).Result;
                httpResponseMessage.EnsureSuccessStatusCode();
            }

            xmlDocument.LoadXml(httpResponseMessage.Content.ReadAsStringAsync().Result);
            _logger.Log(string.Format("{0}, response: {1}", LogUtils.GetCurrentMethod(this), xmlDocument.OuterXml));
            return ParseXmlResult(xmlDocument);

            #region SUCESS RETURN
            //<?xml version="1.0" encoding="UTF-8" standalone="yes"?><virtualmachine snapshotIdentifier="35724"><identifier>25057</identifier><name>CD119740-windows-25057</name><queueitem><identifier>82025</identifier><name>UPGRADE</name><state>SCHEDULED</state><numberOfFailures>0</numberOfFailures><serviceCode>e5a0719a-a00c-44de-9e77-ec6157482bff</serviceCode><delegatedQueueItems /><startExecution>2014-10-21T15:21:20-02:00</startExecution><doPoweroff>false</doPoweroff><doPoweron>false</doPoweron><expectedSteps>0</expectedSteps><currentStep>0</currentStep></queueitem><region>TB1</region><state>POWERED_ON</state><cluster><identifier>122</identifier><iprange additional="false"><identifier>1</identifier><region>TB1</region><firstip>177.70.96.4</firstip><lastip>177.70.99.254</lastip></iprange><software><flags>WIN</flags><identifier>62</identifier><name>windows-2012-64b-std-web-sx</name><fileSystem>refs</fileSystem><initialDisks><initialDisk><identifier>191</identifier><diskName>xvda</diskName><diskType>SO</diskType><format>raw</format></initialDisk></initialDisks><placement>nfs</placement><size>40</size><user><flags>SOFTWARE_PUBLISHER</flags><identifier>304</identifier><name>CD117497</name><additionalips /><firewallrules /><ipranges /><mssKey>N5U1L28WVRSHTQQJTP1J</mssKey><mssSecretKey>BMfaY09IsmYRbL9ZTd+VirHcMVMMTnWFAX5sqS1D</mssSecretKey><vlans /></user></software><storage><identifier>1</identifier><name>spsto001</name><region>TB1</region><state>POWERED_ON</state><admState>preferred</admState><ip>177.70.104.144</ip><keepalive>5</keepalive><opState>loaded</opState><port>5200</port><technology>nfs</technology><version></version><freeSize>5121722286080</freeSize><internalIp>10.14.0.2</internalIp><size>36722</size></storage></cluster><disks><disk snapshotIdentifier="70947"><identifier>9693</identifier><name>d9693</name><device>xvda</device><diskType>SO</diskType><format>raw</format><size>40</size><storage><identifier>1</identifier><name>spsto001</name><region>TB1</region><state>POWERED_ON</state><admState>preferred</admState><ip>177.70.104.144</ip><keepalive>5</keepalive><opState>loaded</opState><port>5200</port><technology>nfs</technology><version></version><freeSize>5121722286080</freeSize><internalIp>10.14.0.2</internalIp><size>36722</size></storage></disk><disk snapshotIdentifier="70948"><identifier>9698</identifier><name>d9698</name><device>xvdb</device><diskType>DATA</diskType><format>vhd</format><size>60</size><storage><identifier>1</identifier><name>spsto001</name><region>TB1</region><state>POWERED_ON</state><admState>preferred</admState><ip>177.70.104.144</ip><keepalive>5</keepalive><opState>loaded</opState><port>5200</port><technology>nfs</technology><version></version><freeSize>5121722286080</freeSize><internalIp>10.14.0.2</internalIp><size>36722</size></storage><user><identifier>637</identifier><name>CD119740</name><ipranges /></user></disk></disks><frequency>900</frequency><host><flags>NO_TRUEBOX,NO_SQL,NO_WIN7</flags><identifier>9</identifier><name>spc1p009</name><region>TB1</region><state>POWERED_ON</state><admState>regular</admState><ip>177.70.104.143</ip><keepalive>3</keepalive><opState>running</opState><port>5200</port><technology>xen</technology><version>41</version><freeMemory>724</freeMemory><frequency>2000</frequency><loadAverage>2.03</loadAverage><memory>98226</memory><storages><storage><identifier>1</identifier><name>spsto001</name><region>TB1</region><state>POWERED_ON</state><admState>preferred</admState><ip>177.70.104.144</ip><keepalive>5</keepalive><opState>loaded</opState><port>5200</port><technology>nfs</technology><version></version><freeSize>5121722286080</freeSize><internalIp>10.14.0.2</internalIp><size>36722</size></storage><storage><identifier>2</identifier><name>spsto002</name><region>TB1</region><state>POWERED_ON</state><admState>preferred</admState><ip>177.70.104.144</ip><keepalive>5</keepalive><opState>loaded</opState><port>5200</port><technology>nfs</technology><version></version><freeSize>4686096629760</freeSize><internalIp>10.15.0.2</internalIp><size>40059</size></storage></storages><vcpu>32</vcpu></host><memory>2097152</memory><networkinterfaces><networkinterface snapshotIdentifier="39941"><identifier>5315</identifier><name>tec25057.0</name><additionalips><additionalip inrange="true" snapshotIdentifier="29415"><identifier>978</identifier><ipv4>177.70.97.117</ipv4></additionalip></additionalips><bandwidth>1.0</bandwidth><ipv4>177.70.97.115</ipv4><mac>00:16:3e:6b:14:7b</mac><monitor><identifier>627</identifier><user><identifier>637</identifier><name>CD119740</name><ipranges /></user><vlan validRange="true" firewall="true" dhcp="true"><identifier>1</identifier><name>virtbr8</name><region>TB1</region><firewallrules /><ipranges><iprange additional="false"><identifier>1</identifier><region>TB1</region><firstip>177.70.96.4</firstip><lastip>177.70.99.254</lastip></iprange><iprange additional="false"><identifier>2</identifier><firstip>192.168.168.1</firstip><lastip>192.168.168.254</lastip></iprange><iprange additional="false"><identifier>3</identifier><firstip>10.2.0.7</firstip><lastip>10.2.0.254</lastip></iprange><iprange additional="false"><identifier>4</identifier><firstip>10.1.1.7</firstip><lastip>10.1.1.254</lastip></iprange><iprange additional="false"><identifier>5</identifier><firstip>192.168.200.7</firstip><lastip>192.168.200.254</lastip></iprange><iprange additional="false"><identifier>7</identifier><firstip>192.168.41.7</firstip><lastip>192.168.41.254</lastip></iprange><iprange additional="false"><identifier>8</identifier><firstip>192.168.201.7</firstip><lastip>192.168.201.254</lastip></iprange><iprange additional="false"><identifier>9</identifier><firstip>192.168.202.7</firstip><lastip>192.168.202.254</lastip></iprange><iprange additional="false"><identifier>12</identifier><firstip>192.168.204.7</firstip><lastip>192.168.204.254</lastip></iprange><iprange additional="false"><identifier>13</identifier><firstip>192.168.205.7</firstip><lastip>192.168.205.254</lastip></iprange><iprange additional="false"><identifier>14</identifier><firstip>192.168.4.7</firstip><lastip>192.168.4.254</lastip></iprange><iprange additional="false"><identifier>15</identifier><firstip>192.168.207.7</firstip><lastip>192.168.207.254</lastip></iprange><iprange additional="false"><identifier>18</identifier><firstip>192.168.208.7</firstip><lastip>192.168.208.254</lastip></iprange><iprange additional="false"><identifier>23</identifier><firstip>192.168.56.7</firstip><lastip>192.168.56.254</lastip></iprange><iprange additional="false"><identifier>24</identifier><firstip>192.168.209.7</firstip><lastip>192.168.209.254</lastip></iprange><iprange additional="false"><identifier>26</identifier><firstip>192.168.11.7</firstip><lastip>192.168.11.254</lastip></iprange><iprange additional="false"><identifier>27</identifier><firstip>192.168.12.7</firstip><lastip>192.168.12.254</lastip></iprange><iprange additional="false"><identifier>28</identifier><firstip>192.168.211.7</firstip><lastip>192.168.211.254</lastip></iprange><iprange additional="false"><identifier>30</identifier><firstip>192.168.212.7</firstip><lastip>192.168.212.254</lastip></iprange><iprange additional="false"><identifier>31</identifier><firstip>192.168.213.7</firstip><lastip>192.168.213.254</lastip></iprange><iprange additional="false"><identifier>32</identifier><firstip>192.168.214.7</firstip><lastip>192.168.214.254</lastip></iprange><iprange additional="false"><identifier>34</identifier><firstip>192.168.14.7</firstip><lastip>192.168.14.254</lastip></iprange><iprange additional="false"><identifier>35</identifier><firstip>192.168.216.7</firstip><lastip>192.168.216.254</lastip></iprange><iprange additional="false"><identifier>36</identifier><firstip>10.0.0.7</firstip><lastip>10.0.0.254</lastip></iprange><iprange additional="false"><identifier>39</identifier><firstip>192.168.217.7</firstip><lastip>192.168.217.254</lastip></iprange><iprange additional="false"><identifier>43</identifier><firstip>192.168.221.7</firstip><lastip>192.168.221.254</lastip></iprange><iprange additional="false"><identifier>44</identifier><firstip>192.168.222.7</firstip><lastip>192.168.222.254</lastip></iprange></ipranges><networkPrefixSize>0</networkPrefixSize><router><identifier>1</identifier><name>SPFW001</name><region>TB1</region><admState>regular</admState><ip>177.70.104.129</ip><externalIf>bond0.1000</externalIf><internalIf>bond0</internalIf><rate>10000Mbit</rate><secondaryVirtualIp>0.0.0.0</secondaryVirtualIp></router><vlanid>8</vlanid></vlan></monitor><vlan validRange="true" firewall="true" dhcp="true"><identifier>1</identifier><name>virtbr8</name><region>TB1</region><firewallrules /><ipranges><iprange additional="false"><identifier>1</identifier><region>TB1</region><firstip>177.70.96.4</firstip><lastip>177.70.99.254</lastip></iprange><iprange additional="false"><identifier>2</identifier><firstip>192.168.168.1</firstip><lastip>192.168.168.254</lastip></iprange><iprange additional="false"><identifier>3</identifier><firstip>10.2.0.7</firstip><lastip>10.2.0.254</lastip></iprange><iprange additional="false"><identifier>4</identifier><firstip>10.1.1.7</firstip><lastip>10.1.1.254</lastip></iprange><iprange additional="false"><identifier>5</identifier><firstip>192.168.200.7</firstip><lastip>192.168.200.254</lastip></iprange><iprange additional="false"><identifier>7</identifier><firstip>192.168.41.7</firstip><lastip>192.168.41.254</lastip></iprange><iprange additional="false"><identifier>8</identifier><firstip>192.168.201.7</firstip><lastip>192.168.201.254</lastip></iprange><iprange additional="false"><identifier>9</identifier><firstip>192.168.202.7</firstip><lastip>192.168.202.254</lastip></iprange><iprange additional="false"><identifier>12</identifier><firstip>192.168.204.7</firstip><lastip>192.168.204.254</lastip></iprange><iprange additional="false"><identifier>13</identifier><firstip>192.168.205.7</firstip><lastip>192.168.205.254</lastip></iprange><iprange additional="false"><identifier>14</identifier><firstip>192.168.4.7</firstip><lastip>192.168.4.254</lastip></iprange><iprange additional="false"><identifier>15</identifier><firstip>192.168.207.7</firstip><lastip>192.168.207.254</lastip></iprange><iprange additional="false"><identifier>18</identifier><firstip>192.168.208.7</firstip><lastip>192.168.208.254</lastip></iprange><iprange additional="false"><identifier>23</identifier><firstip>192.168.56.7</firstip><lastip>192.168.56.254</lastip></iprange><iprange additional="false"><identifier>24</identifier><firstip>192.168.209.7</firstip><lastip>192.168.209.254</lastip></iprange><iprange additional="false"><identifier>26</identifier><firstip>192.168.11.7</firstip><lastip>192.168.11.254</lastip></iprange><iprange additional="false"><identifier>27</identifier><firstip>192.168.12.7</firstip><lastip>192.168.12.254</lastip></iprange><iprange additional="false"><identifier>28</identifier><firstip>192.168.211.7</firstip><lastip>192.168.211.254</lastip></iprange><iprange additional="false"><identifier>30</identifier><firstip>192.168.212.7</firstip><lastip>192.168.212.254</lastip></iprange><iprange additional="false"><identifier>31</identifier><firstip>192.168.213.7</firstip><lastip>192.168.213.254</lastip></iprange><iprange additional="false"><identifier>32</identifier><firstip>192.168.214.7</firstip><lastip>192.168.214.254</lastip></iprange><iprange additional="false"><identifier>34</identifier><firstip>192.168.14.7</firstip><lastip>192.168.14.254</lastip></iprange><iprange additional="false"><identifier>35</identifier><firstip>192.168.216.7</firstip><lastip>192.168.216.254</lastip></iprange><iprange additional="false"><identifier>36</identifier><firstip>10.0.0.7</firstip><lastip>10.0.0.254</lastip></iprange><iprange additional="false"><identifier>39</identifier><firstip>192.168.217.7</firstip><lastip>192.168.217.254</lastip></iprange><iprange additional="false"><identifier>43</identifier><firstip>192.168.221.7</firstip><lastip>192.168.221.254</lastip></iprange><iprange additional="false"><identifier>44</identifier><firstip>192.168.222.7</firstip><lastip>192.168.222.254</lastip></iprange></ipranges><networkPrefixSize>0</networkPrefixSize><router><identifier>1</identifier><name>SPFW001</name><region>TB1</region><admState>regular</admState><ip>177.70.104.129</ip><externalIf>bond0.1000</externalIf><internalIf>bond0</internalIf><rate>10000Mbit</rate><secondaryVirtualIp>0.0.0.0</secondaryVirtualIp></router><vlanid>8</vlanid></vlan></networkinterface></networkinterfaces><software><flags>WIN</flags><identifier>62</identifier><name>windows-2012-64b-std-web-sx</name><fileSystem>refs</fileSystem><initialDisks><initialDisk><identifier>191</identifier><diskName>xvda</diskName><diskType>SO</diskType><format>raw</format></initialDisk></initialDisks><placement>nfs</placement><size>40</size><user><flags>SOFTWARE_PUBLISHER</flags><identifier>304</identifier><name>CD117497</name><additionalips /><firewallrules /><ipranges /><mssKey>N5U1L28WVRSHTQQJTP1J</mssKey><mssSecretKey>BMfaY09IsmYRbL9ZTd+VirHcMVMMTnWFAX5sqS1D</mssSecretKey><vlans /></user></software><user><identifier>637</identifier><name>CD119740</name><ipranges /></user><vcpu>2</vcpu><vncPasswd>EHBsROzyf7</vncPasswd><vncPort>5920</vncPort></virtualmachine>
            #endregion

            #region FAIL RETURN
            //<?xml version="1.0" encoding="UTF-8" standalone="yes"?><virtualmachine><identifier>25057</identifier><name>CD119740-windows-25057</name><queueitem><identifier>0</identifier><name>UPGRADE</name><state>REJECTED</state><numberOfFailures>0</numberOfFailures><serviceCode>e5a0719a-a00c-44de-9e77-ec6157482bff</serviceCode><delegatedQueueItems /><startExecution>2014-10-21T15:21:20-02:00</startExecution><doPoweroff>false</doPoweroff><doPoweron>false</doPoweron><expectedSteps>0</expectedSteps><currentStep>0</currentStep><message>ValidationException: ServiceCode is not unique</message></queueitem><frequency>900</frequency><memory>2097152</memory><vcpu>2</vcpu></virtualmachine>
            #endregion
        }
    }
}